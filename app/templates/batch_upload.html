<!-- app/templates/batch_upload.html -->
{% extends "base.html" %}

{% block title %}Batch Upload - DQA Analysis{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-sky-50 via-white to-emerald-50">
    <!-- Header -->
    <div class="bg-white border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900">Batch Facility Upload</h1>
                    <p class="text-slate-600 mt-2">Upload multiple facilities at once (sets of 3 files each)</p>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('routes.analysis') }}"
                       class="inline-flex items-center px-4 py-2 bg-slate-100 border border-slate-300 text-slate-700 rounded-xl text-sm font-medium hover:bg-slate-200 transition">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Single Upload
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Upload Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl p-8 shadow-lg border border-slate-200">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center mr-4">
                            <i class="fas fa-layer-group text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Batch Upload Instructions</h2>
                            <p class="text-slate-600">Upload multiple facility bundles in one go</p>
                        </div>
                    </div>

                    <!-- Flash messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                      {% if messages %}
                        <div class="mb-6 space-y-2">
                          {% for category, message in messages %}
                            {% if category == 'warning' %}
                            <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg text-sm">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                {{ message }}
                            </div>
                            {% else %}
                            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                {{ message }}
                            </div>
                            {% endif %}
                          {% endfor %}
                        </div>
                      {% endif %}
                    {% endwith %}

                    <!-- Upload Form -->
                    <form
                        action="{{ url_for('routes.upload_batch') }}"
                        method="post"
                        enctype="multipart/form-data"
                        class="space-y-6"
                        id="batchUploadForm"
                    >
                        <!-- Quarter Selection -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">
                                <i class="fas fa-calendar mr-2"></i>
                                Select Quarter for All Facilities
                            </label>
                            <select
                                name="quarter"
                                class="w-full bg-white border border-slate-300 rounded-xl px-4 py-3 text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                            >
                                {% for q in quarters %}
                                    <option value="{{ q }}" {% if q == 'Q4' %}selected{% endif %}>{{ q }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- File Upload -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">
                                <i class="fas fa-folder-open mr-2"></i>
                                Upload Facility Files (Multiples of 3)
                            </label>

                            <div class="border-2 border-dashed border-slate-300 rounded-2xl p-8 text-center hover:border-blue-400 transition">
                                <input
                                    type="file"
                                    name="facility_files"
                                    accept=".xls,.xlsx"
                                    class="hidden"
                                    id="batchInput"
                                    multiple
                                    required
                                />
                                <div class="mb-4">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-slate-400 mb-3"></i>
                                    <p class="text-base font-medium text-slate-700">Drop facility files here or click to browse</p>
                                    <p class="text-slate-500 text-sm mt-1">
                                        Upload files in sets of 3 (DVV + Client Level + VL) for each facility
                                    </p>
                                    <p class="text-slate-500 text-xs mt-2">
                                        Files will be processed in the order they are selected
                                    </p>
                                </div>
                                <button
                                    type="button"
                                    onclick="document.getElementById('batchInput').click()"
                                    class="inline-flex items-center px-6 py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 transition"
                                >
                                    <i class="fas fa-folder-open mr-2"></i>
                                    Choose Multiple Files
                                </button>
                            </div>
                            <div id="batchList" class="mt-4 space-y-2 max-h-60 overflow-y-auto p-2"></div>
                        </div>

                        <!-- File Size Warning -->
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-3"></i>
                                <div>
                                    <p class="text-sm font-medium text-blue-800">Important Notes:</p>
                                    <ul class="text-xs text-blue-600 mt-1 space-y-1">
                                        <li>• Upload files in multiples of 3 (sets for each facility)</li>
                                        <li>• Each set should contain: DVV Template + Client Level + VL Unsuppressed</li>
                                        <li>• Files will be processed in the order they are selected</li>
                                        <li>• Maximum total upload size: 250MB</li>
                                        <li>• Processing may take several minutes for large batches</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Processing Status -->
                        <div id="batchProcessingStatus" class="hidden p-4 bg-blue-50 border border-blue-200 rounded-xl">
                            <div class="flex items-center">
                                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3"></div>
                                <div>
                                    <p class="text-sm font-medium text-blue-800">Processing batch files...</p>
                                    <p class="text-xs text-blue-600 mt-1">This may take a few moments depending on the number of files.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button
                            type="submit"
                            id="batchSubmitBtn"
                            class="w-full inline-flex items-center justify-center px-8 py-4 rounded-2xl bg-gradient-to-r from-blue-500 to-cyan-400 text-white font-semibold text-lg shadow-lg shadow-blue-500/30 hover:from-blue-400 hover:to-cyan-300 transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                            disabled
                        >
                            <i class="fas fa-cogs mr-3"></i>
                            Process Batch Upload
                        </button>

                        <!-- File Count Info -->
                        <div id="fileCountInfo" class="hidden text-center text-sm text-slate-600">
                            <p>Selected files: <span id="fileCount">0</span></p>
                            <p>Expected facility count: <span id="facilityCount">0</span></p>
                        </div>
                    </form>
                </div>

                <!-- Processing Info -->
                <div class="bg-white rounded-2xl p-6 shadow-lg border border-slate-200 mt-8">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">How Batch Processing Works</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center p-4 bg-blue-50 rounded-xl border border-blue-200">
                            <i class="fas fa-sort-numeric-up text-blue-600 text-2xl mb-3"></i>
                            <h4 class="font-semibold text-slate-900">File Grouping</h4>
                            <p class="text-slate-600 text-sm mt-1">Files are grouped into sets of 3 (DVV, Client, VL) for each facility</p>
                        </div>
                        <div class="text-center p-4 bg-emerald-50 rounded-xl border border-emerald-200">
                            <i class="fas fa-tasks text-emerald-600 text-2xl mb-3"></i>
                            <h4 class="font-semibold text-slate-900">Parallel Processing</h4>
                            <p class="text-slate-600 text-sm mt-1">Each facility bundle is processed independently for efficiency</p>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-xl border border-purple-200">
                            <i class="fas fa-chart-line text-purple-600 text-2xl mb-3"></i>
                            <h4 class="font-semibold text-slate-900">Results Summary</h4>
                            <p class="text-slate-600 text-sm mt-1">Get a summary of successful and failed facilities after processing</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-8">
                <!-- Quick Stats -->
                <div class="bg-white rounded-2xl p-6 shadow-lg border border-slate-200">
                    <h3 class="font-semibold text-slate-900 mb-4">Batch Upload Requirements</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-600">Files per Facility</span>
                            <span class="font-semibold text-blue-600">3 files</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-600">File Order</span>
                            <span class="font-semibold text-slate-900">Sequential</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-600">Max Total Size</span>
                            <span class="font-semibold text-emerald-600">250MB</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-600">Supported Formats</span>
                            <span class="font-semibold text-blue-600">.xls, .xlsx</span>
                        </div>
                    </div>
                </div>

                <!-- Recommended Structure -->
                <div class="bg-white rounded-2xl p-6 shadow-lg border border-slate-200">
                    <h3 class="font-semibold text-slate-900 mb-4">Recommended File Naming</h3>
                    <div class="space-y-3">
                        <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <p class="text-xs font-medium text-slate-700 mb-1">Facility 1</p>
                            <p class="text-xs text-slate-600">facility1_dvv.xlsx</p>
                            <p class="text-xs text-slate-600">facility1_client.xlsx</p>
                            <p class="text-xs text-slate-600">facility1_vl.xlsx</p>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <p class="text-xs font-medium text-slate-700 mb-1">Facility 2</p>
                            <p class="text-xs text-slate-600">facility2_dvv.xlsx</p>
                            <p class="text-xs text-slate-600">facility2_client.xlsx</p>
                            <p class="text-xs text-slate-600">facility2_vl.xlsx</p>
                        </div>
                    </div>
                </div>

                <!-- Processing Tips -->
                <div class="bg-white rounded-2xl p-6 shadow-lg border border-slate-200">
                    <h3 class="font-semibold text-slate-900 mb-4">Processing Tips</h3>
                    <ul class="space-y-3 text-sm text-slate-700">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-emerald-500 mt-0.5 mr-3 flex-shrink-0"></i>
                            <span>Ensure each facility has exactly 3 files</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-emerald-500 mt-0.5 mr-3 flex-shrink-0"></i>
                            <span>Select files in the correct order (DVV, Client, VL)</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-emerald-500 mt-0.5 mr-3 flex-shrink-0"></i>
                            <span>Large batches may take several minutes to process</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-emerald-500 mt-0.5 mr-3 flex-shrink-0"></i>
                            <span>Check the performance dashboard after processing</span>
                        </li>
                    </ul>
                </div>

                <!-- Quick Links -->
                <div class="bg-gradient-to-r from-blue-500 to-emerald-500 rounded-2xl p-6 text-white">
                    <h3 class="font-semibold mb-3">Need to Upload Just One?</h3>
                    <p class="text-blue-100 text-sm mb-4">If you only have one facility to process, use the single upload option</p>
                    <a href="{{ url_for('routes.analysis') }}"
                       class="inline-flex items-center justify-center w-full px-4 py-3 bg-white text-blue-600 rounded-xl font-semibold hover:bg-blue-50 transition">
                        <i class="fas fa-upload mr-2"></i>
                        Single Facility Upload
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Utility to render file previews
    function renderBatchFiles() {
        const input = document.getElementById('batchInput');
        const listEl = document.getElementById('batchList');
        const submitBtn = document.getElementById('batchSubmitBtn');
        const fileCountEl = document.getElementById('fileCount');
        const facilityCountEl = document.getElementById('facilityCount');
        const fileCountInfo = document.getElementById('fileCountInfo');
        
        listEl.innerHTML = '';
        
        if (!input.files || input.files.length === 0) {
            submitBtn.disabled = true;
            fileCountInfo.classList.add('hidden');
            return;
        }
        
        const files = Array.from(input.files);
        const fileCount = files.length;
        const facilityCount = Math.floor(fileCount / 3);
        
        // Update counts
        fileCountEl.textContent = fileCount;
        facilityCountEl.textContent = facilityCount;
        fileCountInfo.classList.remove('hidden');
        
        // Check if we have multiples of 3
        const isValidBatch = fileCount % 3 === 0 && fileCount > 0;
        submitBtn.disabled = !isValidBatch;
        
        // Calculate total size
        const totalSizeMB = files.reduce((total, file) => total + (file.size / (1024 * 1024)), 0);
        const maxSizeMB = 250;
        const isSizeValid = totalSizeMB <= maxSizeMB;
        
        if (!isSizeValid) {
            submitBtn.disabled = true;
            listEl.innerHTML = `
                <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm font-medium text-red-700">Total file size (${totalSizeMB.toFixed(2)}MB) exceeds ${maxSizeMB}MB limit</p>
                </div>
            `;
            return;
        }
        
        if (!isValidBatch) {
            listEl.innerHTML = `
                <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm font-medium text-yellow-700">Upload ${3 - (fileCount % 3)} more file(s) to complete the last facility set</p>
                    <p class="text-xs text-yellow-600 mt-1">Files must be uploaded in sets of 3 (DVV + Client + VL)</p>
                </div>
            `;
        } else {
            listEl.innerHTML = `
                <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
                    <p class="text-sm font-medium text-emerald-700">Ready to process ${facilityCount} facility set(s)</p>
                    <p class="text-xs text-emerald-600 mt-1">Total size: ${totalSizeMB.toFixed(2)}MB</p>
                </div>
            `;
        }
        
        // Display file list (limited to first 10)
        const displayLimit = 10;
        files.slice(0, displayLimit).forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200';
            
            const fileType = (index % 3 === 0) ? 'DVV' : (index % 3 === 1) ? 'Client' : 'VL';
            const fileTypeColors = {
                'DVV': 'text-green-600',
                'Client': 'text-blue-600',
                'VL': 'text-purple-600'
            };
            
            fileItem.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-file-excel ${fileTypeColors[fileType]} mr-3"></i>
                    <div>
                        <p class="text-sm font-medium text-slate-700">${file.name}</p>
                        <p class="text-xs text-slate-500">${fileType} • ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                </div>
                <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700">
                    ${Math.floor(index / 3) + 1}
                </span>
            `;
            listEl.appendChild(fileItem);
        });
        
        if (files.length > displayLimit) {
            const moreItem = document.createElement('div');
            moreItem.className = 'text-center p-2 text-sm text-slate-500';
            moreItem.textContent = `+ ${files.length - displayLimit} more files`;
            listEl.appendChild(moreItem);
        }
    }

    // Batch input binding
    const batchInput = document.getElementById('batchInput');
    batchInput.addEventListener('change', renderBatchFiles);

    // Drag and drop setup
    const dropArea = document.querySelector('[id="batchUploadForm"] .border-dashed');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => {
            dropArea.classList.add('border-blue-400', 'bg-blue-50');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => {
            dropArea.classList.remove('border-blue-400', 'bg-blue-50');
        }, false);
    });

    dropArea.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (!files || files.length === 0) return;
        
        // Create a new DataTransfer to set files
        const dataTransfer = new DataTransfer();
        Array.from(files).forEach(file => dataTransfer.items.add(file));
        batchInput.files = dataTransfer.files;
        
        // Trigger change event
        batchInput.dispatchEvent(new Event('change'));
    }, false);

    // Form submission handling
    document.getElementById('batchUploadForm').addEventListener('submit', function(e) {
        const files = document.getElementById('batchInput').files;
        const submitBtn = document.getElementById('batchSubmitBtn');
        const processingStatus = document.getElementById('batchProcessingStatus');
        
        if (!files || files.length === 0) {
            e.preventDefault();
            alert('Please select files to upload.');
            return;
        }
        
        if (files.length % 3 !== 0) {
            e.preventDefault();
            alert(`Please upload files in sets of 3. You have ${files.length} file(s) (${files.length % 3} extra).`);
            return;
        }
        
        // Check total file size (250MB limit)
        const maxSize = 250 * 1024 * 1024; // 250MB in bytes
        let totalSize = 0;
        
        for (let i = 0; i < files.length; i++) {
            totalSize += files[i].size;
        }
        
        if (totalSize > maxSize) {
            e.preventDefault();
            alert(`Total file size (${(totalSize / (1024 * 1024)).toFixed(2)}MB) exceeds 250MB limit.`);
            return;
        }
        
        // Show processing status
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i> Processing Batch...';
        processingStatus.classList.remove('hidden');
    });
</script>
{% endblock %}